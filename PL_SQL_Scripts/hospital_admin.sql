/* ==================================================
   PHẦN 1: DDL - TẠO BẢNG VÀ RÀNG BUỘC
   Cập nhật: Bỏ cột 'status' trong bảng VISIT
   ================================================== */

-- Xóa các bảng cũ để làm sạch môi trường
DROP TABLE PRESCRIPTION_DETAIL CASCADE CONSTRAINTS;
DROP TABLE PRESCRIPTION CASCADE CONSTRAINTS;
DROP TABLE VISIT CASCADE CONSTRAINTS;
DROP TABLE STAFF CASCADE CONSTRAINTS;
DROP TABLE PATIENT CASCADE CONSTRAINTS;
DROP TABLE MEDICINE CASCADE CONSTRAINTS;
DROP TABLE DEPARTMENT CASCADE CONSTRAINTS;

-- 1. Bảng DEPARTMENT
CREATE TABLE DEPARTMENT (
    department_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    department_name VARCHAR2(100) NOT NULL
);

-- 2. Bảng MEDICINE
CREATE TABLE MEDICINE (
    medicine_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    medicine_name VARCHAR2(150) NOT NULL,
    unit VARCHAR2(50),
    price NUMBER
);

-- 3. Bảng PATIENT
CREATE TABLE PATIENT (
    patient_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    full_name VARCHAR2(100) NOT NULL,
    dob DATE,
    gender CHAR(1) CHECK (gender IN ('M', 'F')),
    phone VARCHAR2(20),
    address VARCHAR2(255),
    insurance_number VARCHAR2(50)
);

-- 4. Bảng STAFF
CREATE TABLE STAFF (
    staff_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    full_name VARCHAR2(100) NOT NULL,
    username VARCHAR2(50) UNIQUE NOT NULL,
    password_hash VARCHAR2(200) NOT NULL,
    role VARCHAR2(20) CHECK (role IN ('DOCTOR', 'NURSE', 'ADMIN')),
    phone VARCHAR2(20),
    email VARCHAR2(100),
    department_id NUMBER,
    salary NUMBER,
    CONSTRAINT fk_staff_dept FOREIGN KEY (department_id) REFERENCES DEPARTMENT(department_id)
);

-- 5. Bảng VISIT
-- Đã xóa cột 'status'
CREATE TABLE VISIT (
    visit_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    patient_id NUMBER NOT NULL,
    staff_id NUMBER NOT NULL, -- Bác sĩ khám
    department_id NUMBER,     -- Khoa khám
    visit_date DATE DEFAULT SYSDATE,
    diagnosis CLOB,
    notes CLOB,
    CONSTRAINT fk_visit_patient FOREIGN KEY (patient_id) REFERENCES PATIENT(patient_id),
    CONSTRAINT fk_visit_staff FOREIGN KEY (staff_id) REFERENCES STAFF(staff_id),
    CONSTRAINT fk_visit_dept FOREIGN KEY (department_id) REFERENCES DEPARTMENT(department_id)
);

-- 6. Bảng PRESCRIPTION
CREATE TABLE PRESCRIPTION (
    prescription_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    visit_id NUMBER NOT NULL,
    staff_id NUMBER NOT NULL,
    created_date DATE DEFAULT SYSDATE,
    notes VARCHAR2(255),
    CONSTRAINT fk_pres_visit FOREIGN KEY (visit_id) REFERENCES VISIT(visit_id),
    CONSTRAINT fk_pres_staff FOREIGN KEY (staff_id) REFERENCES STAFF(staff_id)
);

-- 7. Bảng PRESCRIPTION_DETAIL
CREATE TABLE PRESCRIPTION_DETAIL (
    detail_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    prescription_id NUMBER NOT NULL,
    medicine_id NUMBER NOT NULL,
    quantity NUMBER NOT NULL,
    dosage VARCHAR2(100),
    CONSTRAINT fk_detail_pres FOREIGN KEY (prescription_id) REFERENCES PRESCRIPTION(prescription_id),
    CONSTRAINT fk_detail_med FOREIGN KEY (medicine_id) REFERENCES MEDICINE(medicine_id)
);


/* ==================================================
   PHẦN 2: DML - INSERT DỮ LIỆU MẪU
   Đã cập nhật câu lệnh INSERT cho bảng VISIT (bỏ giá trị status)
   ================================================== */

-- 1. Data for DEPARTMENT
INSERT INTO DEPARTMENT (department_name) VALUES ('Khoa Nội tổng hợp');
INSERT INTO DEPARTMENT (department_name) VALUES ('Khoa Ngoại');
INSERT INTO DEPARTMENT (department_name) VALUES ('Khoa Nhi');
INSERT INTO DEPARTMENT (department_name) VALUES ('Khoa Cấp cứu');
INSERT INTO DEPARTMENT (department_name) VALUES ('Phòng Hành chính');

-- 2. Data for MEDICINE
INSERT INTO MEDICINE (medicine_name, unit, price) VALUES ('Paracetamol 500mg', 'Viên', 1000);
INSERT INTO MEDICINE (medicine_name, unit, price) VALUES ('Ibuprofen 400mg', 'Viên', 2500);
INSERT INTO MEDICINE (medicine_name, unit, price) VALUES ('Amoxicillin 500mg', 'Viên', 3000);
INSERT INTO MEDICINE (medicine_name, unit, price) VALUES ('Omeprazol 20mg', 'Viên', 4000);
INSERT INTO MEDICINE (medicine_name, unit, price) VALUES ('Vitamin C sủi', 'Tuýp', 20000);
INSERT INTO MEDICINE (medicine_name, unit, price) VALUES ('Dung dịch Oresol', 'Gói', 2000);
INSERT INTO MEDICINE (medicine_name, unit, price) VALUES ('Thuốc ho long đờm', 'Chai', 35000);
INSERT INTO MEDICINE (medicine_name, unit, price) VALUES ('Betadine sát khuẩn', 'Lọ', 45000);
INSERT INTO MEDICINE (medicine_name, unit, price) VALUES ('Panadol Extra', 'Vỉ', 12000);
INSERT INTO MEDICINE (medicine_name, unit, price) VALUES ('Men vi sinh', 'Ống', 8000);

-- 3. Data for PATIENT
INSERT INTO PATIENT (full_name, dob, gender, phone, address, insurance_number) VALUES ('Nguyễn Văn An', TO_DATE('1990-05-15', 'YYYY-MM-DD'), 'M', '0901234567', '123 Nguyễn Trãi, Hà Nội', 'BH123456789');
INSERT INTO PATIENT (full_name, dob, gender, phone, address, insurance_number) VALUES ('Trần Thị Bình', TO_DATE('1985-10-20', 'YYYY-MM-DD'), 'F', '0909876543', '456 Lê Lợi, TP.HCM', 'BH987654321');
INSERT INTO PATIENT (full_name, dob, gender, phone, address, insurance_number) VALUES ('Lê Văn Cường', TO_DATE('2000-01-01', 'YYYY-MM-DD'), 'M', '0912345678', '789 Trần Hưng Đạo, Đà Nẵng', NULL);
INSERT INTO PATIENT (full_name, dob, gender, phone, address, insurance_number) VALUES ('Phạm Thị Dung', TO_DATE('1978-03-08', 'YYYY-MM-DD'), 'F', '0987654321', 'Số 10 Ngõ 5, Cầu Giấy, HN', 'BH567890123');
INSERT INTO PATIENT (full_name, dob, gender, phone, address, insurance_number) VALUES ('Hoàng Tuấn Anh', TO_DATE('1995-12-25', 'YYYY-MM-DD'), 'M', '0933334444', 'Quận 7, TP.HCM', NULL);
INSERT INTO PATIENT (full_name, dob, gender, phone, address, insurance_number) VALUES ('Ngô Lan Chi', TO_DATE('2015-06-01', 'YYYY-MM-DD'), 'F', '0911223344', 'Ba Đình, Hà Nội', 'BH_CHILD_001');
INSERT INTO PATIENT (full_name, dob, gender, phone, address, insurance_number) VALUES ('Vũ Minh Đức', TO_DATE('1960-09-12', 'YYYY-MM-DD'), 'M', '0955667788', 'Hải Châu, Đà Nẵng', 'BH_RETIRED_99');
INSERT INTO PATIENT (full_name, dob, gender, phone, address, insurance_number) VALUES ('Đặng Thu Hà', TO_DATE('1992-04-30', 'YYYY-MM-DD'), 'F', '0999888777', 'Nha Trang, Khánh Hòa', 'BH_CORP_ABC');
INSERT INTO PATIENT (full_name, dob, gender, phone, address, insurance_number) VALUES ('Bùi Văn Khoa', TO_DATE('1988-07-19', 'YYYY-MM-DD'), 'M', '0944555666', 'Biên Hòa, Đồng Nai', NULL);
INSERT INTO PATIENT (full_name, dob, gender, phone, address, insurance_number) VALUES ('Đỗ Thị Linh', TO_DATE('2005-11-20', 'YYYY-MM-DD'), 'F', '0977778888', 'Thủ Đức, TP.HCM', 'BH_STUDENT_55');

-- 4. Data for STAFF
INSERT INTO STAFF (full_name, username, password_hash, role, phone, email, department_id, salary) VALUES ('Nguyễn Quản Trị', 'admin01', 'hashed_pass_1', 'ADMIN', '0909000111', 'admin01@hospital.com', 5, 25000000);
INSERT INTO STAFF (full_name, username, password_hash, role, phone, email, department_id, salary) VALUES ('Lê Hỗ Trợ', 'admin02', 'hashed_pass_2', 'ADMIN', '0909000222', 'support@hospital.com', 5, 18000000);
INSERT INTO STAFF (full_name, username, password_hash, role, phone, email, department_id, salary) VALUES ('Bs. Trần Bình An', 'doctor_an', 'pass_doc1', 'DOCTOR', '0911111222', 'an.tran@hospital.com', 1, 35000000);
INSERT INTO STAFF (full_name, username, password_hash, role, phone, email, department_id, salary) VALUES ('Bs. Phạm Minh Tâm', 'doctor_tam', 'pass_doc2', 'DOCTOR', '0911111333', 'tam.pham@hospital.com', 1, 32000000);
INSERT INTO STAFF (full_name, username, password_hash, role, phone, email, department_id, salary) VALUES ('Bs. Lê Cường Quốc', 'doctor_quoc', 'pass_doc3', 'DOCTOR', '0922222333', 'quoc.le@hospital.com', 2, 40000000);
INSERT INTO STAFF (full_name, username, password_hash, role, phone, email, department_id, salary) VALUES ('Bs. Hoàng Yến Nhi', 'doctor_nhi', 'pass_doc4', 'DOCTOR', '0933333555', 'nhi.hoang@hospital.com', 3, 30000000);
INSERT INTO STAFF (full_name, username, password_hash, role, phone, email, department_id, salary) VALUES ('Bs. Vũ Việt Hùng', 'doctor_hung', 'pass_doc5', 'DOCTOR', '0933333666', 'hung.vu@hospital.com', 4, 38000000);
INSERT INTO STAFF (full_name, username, password_hash, role, phone, email, department_id, salary) VALUES ('Bs. Đặng Phương Thảo', 'doctor_thao', 'pass_doc6', 'DOCTOR', '0944444777', 'thao.dang@hospital.com', 4, 36000000);
INSERT INTO STAFF (full_name, username, password_hash, role, phone, email, department_id, salary) VALUES ('Yt. Nguyễn Mai Phương', 'nurse_phuong', 'pass_nurse1', 'NURSE', '0955555111', NULL, 1, 15000000);
INSERT INTO STAFF (full_name, username, password_hash, role, phone, email, department_id, salary) VALUES ('Yt. Trần Thị Thu', 'nurse_thu', 'pass_nurse2', 'NURSE', '0955555222', NULL, 2, 14500000);
INSERT INTO STAFF (full_name, username, password_hash, role, phone, email, department_id, salary) VALUES ('Yt. Lê Thanh Tú', 'nurse_tu', 'pass_nurse3', 'NURSE', '0955555333', NULL, 3, 14000000);
INSERT INTO STAFF (full_name, username, password_hash, role, phone, email, department_id, salary) VALUES ('Yt. Phạm Thị Hoa', 'nurse_hoa', 'pass_nurse4', 'NURSE', '0955555444', NULL, 4, 16000000);

-- 5. Data for VISIT (ĐÃ XÓA STATUS)
INSERT INTO VISIT (patient_id, staff_id, department_id, visit_date, diagnosis, notes) VALUES (1, 3, 1, TO_DATE('2023-10-01 08:30', 'YYYY-MM-DD HH24:MI'), 'Viêm họng cấp', 'Sốt nhẹ, đau rát họng.');
INSERT INTO VISIT (patient_id, staff_id, department_id, visit_date, diagnosis, notes) VALUES (2, 4, 1, TO_DATE('2023-10-02 09:15', 'YYYY-MM-DD HH24:MI'), 'Rối loạn tiêu hóa', 'Tiêu chảy cấp.');
INSERT INTO VISIT (patient_id, staff_id, department_id, visit_date, diagnosis, notes) VALUES (3, 5, 2, TO_DATE('2023-10-03 14:00', 'YYYY-MM-DD HH24:MI'), 'Chấn thương phần mềm vai phải', 'Do ngã xe.');
INSERT INTO VISIT (patient_id, staff_id, department_id, visit_date, diagnosis, notes) VALUES (6, 6, 3, TO_DATE('2023-10-05 10:00', 'YYYY-MM-DD HH24:MI'), 'Sốt virus', 'Bé sốt cao 39 độ.');
INSERT INTO VISIT (patient_id, staff_id, department_id, visit_date, diagnosis, notes) VALUES (4, 3, 1, TO_DATE('2023-10-10 11:30', 'YYYY-MM-DD HH24:MI'), 'Tăng huyết áp', 'Tái khám định kỳ.');
INSERT INTO VISIT (patient_id, staff_id, department_id, visit_date, diagnosis, notes) VALUES (5, 5, 2, TO_DATE('2023-10-12 16:45', 'YYYY-MM-DD HH24:MI'), 'Đau dạ dày cấp', 'Tiền sử viêm loét dạ dày.');
INSERT INTO VISIT (patient_id, staff_id, department_id, visit_date, diagnosis, notes) VALUES (7, 7, 4, TO_DATE('2023-10-15 19:30', 'YYYY-MM-DD HH24:MI'), 'Dị ứng cấp', 'Nổi mề đay toàn thân.');
INSERT INTO VISIT (patient_id, staff_id, department_id, visit_date, diagnosis, notes) VALUES (8, 4, 1, TO_DATE('2023-10-18 08:00', 'YYYY-MM-DD HH24:MI'), 'Kiểm tra sức khỏe', 'Không có triệu chứng bất thường.');
INSERT INTO VISIT (patient_id, staff_id, department_id, visit_date, diagnosis, notes) VALUES (9, 7, 4, TO_DATE('2023-10-20 13:15', 'YYYY-MM-DD HH24:MI'), 'Bong gân cổ chân', 'Đã sơ cứu.');
INSERT INTO VISIT (patient_id, staff_id, department_id, visit_date, diagnosis, notes) VALUES (10, 6, 3, TO_DATE('2023-10-22 09:45', 'YYYY-MM-DD HH24:MI'), 'Viêm phế quản', 'Ho nhiều, có đờm.');
INSERT INTO VISIT (patient_id, staff_id, department_id, visit_date, diagnosis, notes) VALUES (1, 3, 1, TO_DATE('2023-10-25 15:30', 'YYYY-MM-DD HH24:MI'), 'Tái khám viêm họng', 'Đã đỡ nhiều, tiếp tục thuốc.');
INSERT INTO VISIT (patient_id, staff_id, department_id, visit_date, diagnosis, notes) VALUES (2, 4, 1, SYSDATE - 1, 'Theo dõi tiêu hóa', NULL);
INSERT INTO VISIT (patient_id, staff_id, department_id, visit_date, diagnosis, notes) VALUES (3, 5, 2, SYSDATE - 1, 'Tái khám chấn thương', 'Cần chụp X-quang lại.');
INSERT INTO VISIT (patient_id, staff_id, department_id, visit_date, diagnosis, notes) VALUES (4, 3, 1, SYSDATE, 'Cảm cúm thông thường', NULL);
INSERT INTO VISIT (patient_id, staff_id, department_id, visit_date, diagnosis, notes) VALUES (5, 7, 4, SYSDATE, 'Tai nạn giao thông', 'Vết thương phần mềm tay trái.');

-- 6. Data for PRESCRIPTION
INSERT INTO PRESCRIPTION (visit_id, staff_id, created_date, notes) VALUES (1, 3, TO_DATE('2023-10-01 08:45', 'YYYY-MM-DD HH24:MI'), 'Uống đủ 5 ngày.');
INSERT INTO PRESCRIPTION (visit_id, staff_id, created_date, notes) VALUES (2, 4, TO_DATE('2023-10-02 09:30', 'YYYY-MM-DD HH24:MI'), 'Bù nước điện giải.');
INSERT INTO PRESCRIPTION (visit_id, staff_id, created_date, notes) VALUES (3, 5, TO_DATE('2023-10-03 14:20', 'YYYY-MM-DD HH24:MI'), 'Nghỉ ngơi 1 tuần.');
INSERT INTO PRESCRIPTION (visit_id, staff_id, created_date, notes) VALUES (4, 6, TO_DATE('2023-10-05 10:20', 'YYYY-MM-DD HH24:MI'), 'Uống thuốc hạ sốt khi cần.');
INSERT INTO PRESCRIPTION (visit_id, staff_id, created_date, notes) VALUES (5, 3, TO_DATE('2023-10-10 11:50', 'YYYY-MM-DD HH24:MI'), 'Duy trì thuốc huyết áp.');
INSERT INTO PRESCRIPTION (visit_id, staff_id, created_date, notes) VALUES (6, 5, TO_DATE('2023-10-12 17:00', 'YYYY-MM-DD HH24:MI'), 'Kiêng đồ cay nóng.');
INSERT INTO PRESCRIPTION (visit_id, staff_id, created_date, notes) VALUES (7, 7, TO_DATE('2023-10-15 19:50', 'YYYY-MM-DD HH24:MI'), 'Theo dõi phản ứng thuốc.');
INSERT INTO PRESCRIPTION (visit_id, staff_id, created_date, notes) VALUES (8, 4, TO_DATE('2023-10-18 08:30', 'YYYY-MM-DD HH24:MI'), 'Bổ sung Vitamin.');
INSERT INTO PRESCRIPTION (visit_id, staff_id, created_date, notes) VALUES (9, 7, TO_DATE('2023-10-20 13:30', 'YYYY-MM-DD HH24:MI'), 'Chườm lạnh.');
INSERT INTO PRESCRIPTION (visit_id, staff_id, created_date, notes) VALUES (10, 6, TO_DATE('2023-10-22 10:00', 'YYYY-MM-DD HH24:MI'), 'Kháng sinh 7 ngày.');
INSERT INTO PRESCRIPTION (visit_id, staff_id, created_date, notes) VALUES (11, 3, TO_DATE('2023-10-25 15:45', 'YYYY-MM-DD HH24:MI'), 'Tái khám sau 2 ngày.');
INSERT INTO PRESCRIPTION (visit_id, staff_id, created_date, notes) VALUES (12, 4, SYSDATE - 1, 'Uống Men vi sinh.');
INSERT INTO PRESCRIPTION (visit_id, staff_id, created_date, notes) VALUES (13, 5, SYSDATE - 1, 'Thuốc giảm đau mạnh.');
INSERT INTO PRESCRIPTION (visit_id, staff_id, created_date, notes) VALUES (14, 3, SYSDATE, 'Nghỉ ngơi, giữ ấm.');
INSERT INTO PRESCRIPTION (visit_id, staff_id, created_date, notes) VALUES (15, 7, SYSDATE, 'Kháng sinh dự phòng nhiễm trùng.');

-- 7. Data for PRESCRIPTION_DETAIL
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (1, 1, 10, 'Ngày 2 viên, chia 2 lần');
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (1, 3, 15, 'Ngày 3 viên, chia 3 lần');
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (2, 6, 5, 'Pha 1 gói với 200ml nước');
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (2, 10, 20, 'Ngày 2 ống');
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (3, 2, 10, 'Ngày 2 viên khi đau');
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (4, 1, 5, 'Uống 1/2 viên khi sốt > 38.5');
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (4, 5, 1, 'Ngày 1 viên sủi');
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (5, 9, 30, 'Ngày 1 viên (thay thế thuốc huyết áp)');
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (6, 4, 20, 'Ngày 2 viên, trước ăn');
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (7, 9, 10, 'Ngày 2 viên (thay thế thuốc dị ứng)');
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (8, 5, 1, 'Mỗi ngày 1 viên sủi');
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (9, 2, 10, 'Uống khi đau');
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (9, 8, 1, 'Băng gạc sau khi sát khuẩn');
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (10, 3, 20, 'Ngày 2 viên, uống đủ 10 ngày');
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (10, 7, 1, 'Ngày uống 3 lần, mỗi lần 15ml');
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (11, 7, 1, 'Ngậm khi ho');
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (12, 10, 10, 'Ngày 1 ống trước khi ăn');
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (13, 2, 15, 'Ngày 3 viên');
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (14, 1, 10, 'Ngày 2 lần để giảm đau, hạ sốt');
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (14, 5, 1, 'Mỗi ngày 1 viên');
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (15, 3, 10, 'Ngày 2 viên');
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (15, 8, 1, 'Sát trùng vết thương');

COMMIT;

CREATE ROLE nurse_role;
CREATE ROLE doctor_role;
CREATE ROLE admin_role;
GRANT CREATE SESSION TO admin_role, doctor_role, nurse_role;

-- cấp quyền cho admin_role
GRANT SELECT, INSERT, UPDATE ON DEPARTMENT TO admin_role;
GRANT SELECT, INSERT, UPDATE ON STAFF TO admin_role;
GRANT SELECT ON VISIT TO admin_role;

GRANT SELECT ON DEPARTMENT TO admin_role;
GRANT SELECT ON MEDICINE TO admin_role;
GRANT SELECT ON STAFF TO admin_role;
GRANT SELECT ON PATIENT TO admin_role;
GRANT SELECT ON VISIT TO admin_role;
GRANT SELECT ON PRESCRIPTION TO admin_role;
GRANT SELECT ON PRESCRIPTION_DETAIL TO admin_role;

GRANT EXECUTE ON DBMS_RLS TO admin_role;
GRANT EXECUTE ON DBMS_FGA TO admin_role;
GRANT EXECUTE ON DBMS_REDACT TO admin_role;
GRANT CREATE ANY CONTEXT TO admin_role;
GRANT SELECT ON DBA_FGA_AUDIT_TRAIL TO admin_role;

---------------------------------------------------
-- B. CẤP QUYỀN CHO BÁC SĨ (doctor_role)
---------------------------------------------------
GRANT SELECT ON STAFF TO doctor_role;
GRANT SELECT ON DEPARTMENT TO doctor_role;
GRANT SELECT ON MEDICINE TO doctor_role;
GRANT SELECT ON PATIENT TO doctor_role;
-- Quyền thao tác
GRANT SELECT, UPDATE ON VISIT TO doctor_role;
GRANT SELECT, INSERT, UPDATE ON PRESCRIPTION TO doctor_role;
GRANT SELECT, INSERT, UPDATE ON PRESCRIPTION_DETAIL TO doctor_role;
---------------------------------------------------
-- C. CẤP QUYỀN CHO Y TÁ (nurse_role)
---------------------------------------------------
GRANT SELECT ON STAFF TO nurse_role;
GRANT SELECT ON DEPARTMENT TO nurse_role;
GRANT SELECT ON MEDICINE TO nurse_role;
GRANT SELECT ON PRESCRIPTION TO nurse_role;
GRANT SELECT ON PRESCRIPTION_DETAIL TO nurse_role;

GRANT SELECT, INSERT, UPDATE ON PATIENT TO nurse_role;
GRANT SELECT, INSERT, UPDATE ON VISIT TO nurse_role;
GRANT UPDATE (patient_id, staff_id, visit_date) ON VISIT TO nurse_role;

--------------------------------------------------
-- Tạo profile
--------------------------------------------------
ALTER SYSTEM SET RESOURCE_LIMIT = TRUE;



CREATE PROFILE PF_HOSPITAL_ADMIN LIMIT
    FAILED_LOGIN_ATTEMPTS 3         -- Nhập sai 3 lần sẽ bị khóa
    PASSWORD_LIFE_TIME 60           -- Mật khẩu hết hạn sau 60 ngày
    PASSWORD_REUSE_TIME 365         -- Không được dùng lại mật khẩu cũ trong 1 năm
    PASSWORD_REUSE_MAX 5            -- Không trùng với 5 mật khẩu gần nhất
    PASSWORD_LOCK_TIME 1            -- Khóa tài khoản trong 1 ngày nếu vi phạm
    PASSWORD_GRACE_TIME 7           -- Cảnh báo đổi mật khẩu trước 7 ngày
    SESSIONS_PER_USER 1             -- Mỗi Admin chỉ được mở 1 phiên làm việc (tránh share acc)
    IDLE_TIME 30                    -- Treo máy 30 phút tự động ngắt kết nối
    CONNECT_TIME UNLIMITED;         -- Không giới hạn tổng thời gian kết nối (để làm việc lâu dài)


CREATE PROFILE PF_MEDICAL_STAFF LIMIT
    -- 1. Quản lý Mật khẩu
    FAILED_LOGIN_ATTEMPTS 5         -- Cho phép sai 5 lần (đỡ bị khóa nhầm lúc vội)
    PASSWORD_LIFE_TIME 90           -- Mật khẩu hết hạn sau 90 ngày
    PASSWORD_REUSE_TIME 180         -- Không dùng lại trong 6 tháng
    PASSWORD_LOCK_TIME 1/24         -- Chỉ khóa 1 tiếng (để còn quay lại làm việc sớm)
    PASSWORD_GRACE_TIME 7
    SESSIONS_PER_USER 2             -- Cho phép đăng nhập trên 2 thiết bị (ví dụ: PC và Máy tính bảng)
    IDLE_TIME 60                    -- Treo máy 60 phút mới ngắt (dài hơn Admin)
    CONNECT_TIME 600;               -- Giới hạn 1 ca làm việc (10 tiếng), tránh treo nick qua đêm

-- 1. Gán cho nhóm ADMIN (admin01, admin02)
ALTER USER admin01 PROFILE PF_HOSPITAL_ADMIN;
ALTER USER admin02 PROFILE PF_HOSPITAL_ADMIN;

-- 2. Gán cho nhóm DOCTOR (Bác sĩ)
ALTER USER doctor_an PROFILE PF_MEDICAL_STAFF;
ALTER USER doctor_tam PROFILE PF_MEDICAL_STAFF;
ALTER USER doctor_quoc PROFILE PF_MEDICAL_STAFF;
ALTER USER doctor_nhi PROFILE PF_MEDICAL_STAFF;
ALTER USER doctor_hung PROFILE PF_MEDICAL_STAFF;
ALTER USER doctor_thao PROFILE PF_MEDICAL_STAFF;

-- 3. Gán cho nhóm NURSE (Y tá)
ALTER USER nurse_phuong PROFILE PF_MEDICAL_STAFF;
ALTER USER nurse_thu PROFILE PF_MEDICAL_STAFF;
ALTER USER nurse_tu PROFILE PF_MEDICAL_STAFF;
ALTER USER nurse_hoa PROFILE PF_MEDICAL_STAFF;
------------------------------------------
-- Tạo 1 số user 
------------------------------------------
CREATE USER admin01 IDENTIFIED BY 123;
CREATE USER doctor_an IDENTIFIED BY 123;
CREATE USER nurse_tu IDENTIFIED BY 123;
GRANT admin_role TO admin01;
GRANT doctor_role TO doctor_an;
GRANT nurse_role TO nurse_tu;
GRANT CONNECT, RESOURCE TO admin01, doctor_an, nurse_tu;
ALTER USER admin01 QUOTA UNLIMITED ON users; 
ALTER USER doctor_an QUOTA UNLIMITED ON users; 
ALTER USER nurse_tu QUOTA UNLIMITED ON users;
---------------------------------------------------------------------
-- VPD POLICY
---------------------------------------------------------------------
-- VPD 1: Ẩn cột lương (salary) và mật khẩu (password_hash) trên bảng STAFF
-- Tạo  Context
CREATE CONTEXT CTX_HOSPITAL USING HOSPITAL_ADMIN.PKG_SET_CONTEXT;
--  Tạo Package để set Context
CREATE OR REPLACE PACKAGE HOSPITAL_ADMIN.PKG_SET_CONTEXT IS
    PROCEDURE set_role(p_role VARCHAR2);
END;
/
CREATE OR REPLACE PACKAGE BODY HOSPITAL_ADMIN.PKG_SET_CONTEXT IS
    PROCEDURE set_role(p_role VARCHAR2) IS
    BEGIN
        DBMS_SESSION.SET_CONTEXT('CTX_HOSPITAL', 'ROLE', p_role);
    END;
END;
/
--  Cấp quyền cho mọi người chạy Package này
GRANT EXECUTE ON HOSPITAL_ADMIN.PKG_SET_CONTEXT TO PUBLIC;
--  Tạo Trigger Đăng nhập
CREATE OR REPLACE TRIGGER TRG_GET_HOSPITAL_ROLE
AFTER LOGON ON DATABASE
DECLARE
    v_role VARCHAR2(20);
    v_user VARCHAR2(50);
BEGIN
    v_user := SYS_CONTEXT('USERENV', 'SESSION_USER');
    -- Chỉ chạy trigger nếu user nằm trong bảng STAFF
    BEGIN
        -- Đọc Role trực tiếp từ bảng STAFF
        SELECT role INTO v_role
        FROM HOSPITAL_ADMIN.STAFF
        WHERE UPPER(username) = v_user;
        
        -- Lưu vào Context
        HOSPITAL_ADMIN.PKG_SET_CONTEXT.set_role(v_role);
        
    EXCEPTION 
        WHEN NO_DATA_FOUND THEN 
            -- Nếu user không có trong bảng STAFF thì gán là NULL
            HOSPITAL_ADMIN.PKG_SET_CONTEXT.set_role(NULL);
        WHEN OTHERS THEN
            NULL; 
    END;
END;
/
CREATE OR REPLACE FUNCTION HOSPITAL_ADMIN.fn_vpd_salary (
    schema_p IN VARCHAR2,
    table_p  IN VARCHAR2
) RETURN VARCHAR2
IS
    v_role_context VARCHAR2(20);
BEGIN
    -- Lấy Role từ Context (Do Trigger nạp vào)
    v_role_context := SYS_CONTEXT('CTX_HOSPITAL', 'ROLE');

    -- Nếu Role là ADMIN -> Xem hết (Trả về NULL)
    IF v_role_context = 'ADMIN' 
       OR SYS_CONTEXT('USERENV', 'ISDBA') = 'TRUE' 
    THEN
        RETURN NULL;
    END IF;

    -- Còn lại -> Chỉ xem của mình
    RETURN 'UPPER(username) = SYS_CONTEXT(''USERENV'', ''SESSION_USER'')';
END;
/
GRANT EXECUTE ON HOSPITAL_ADMIN.fn_vpd_salary TO PUBLIC;
-- Áp dụng Policy 
BEGIN
    DBMS_RLS.DROP_POLICY('HOSPITAL_ADMIN', 'STAFF', 'vpd_policy_salary');
EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN
    DBMS_RLS.ADD_POLICY (
        object_schema     => 'HOSPITAL_ADMIN',
        object_name       => 'STAFF',
        policy_name       => 'vpd_policy_salary',
        function_schema   => 'HOSPITAL_ADMIN',
        policy_function   => 'fn_vpd_salary',
        statement_types   => 'SELECT',
        sec_relevant_cols => 'salary',
        sec_relevant_cols_opt => DBMS_RLS.ALL_ROWS
    );
END;
/
--------------------------------------------------------------------------------------
-- VPD 2: Ngăn chặn nhân viên thường nhìn thấy thông tin tài khoản của Admin trong danh sách nhân sự (tránh Social Engineering).
CREATE OR REPLACE FUNCTION HOSPITAL_ADMIN.fn_vpd_hide_admins (
    schema_p IN VARCHAR2,
    table_p  IN VARCHAR2
) RETURN VARCHAR2
IS
    v_role_context VARCHAR2(20);
BEGIN
    -- Lấy Role từ Context (Do Trigger nạp vào lúc đăng nhập)
    v_role_context := SYS_CONTEXT('CTX_HOSPITAL', 'ROLE');

    -- Nếu Context là 'ADMIN' 
    -- HOẶC là chủ sở hữu (HOSPITAL_ADMIN, SYS)
    -- HOẶC là DBA -> Thì được xem hết (không áp dụng bộ lọc)
    IF v_role_context = 'ADMIN' 
       OR SYS_CONTEXT('USERENV', 'SESSION_USER') IN ('HOSPITAL_ADMIN', 'SYS') 
       OR SYS_CONTEXT('USERENV', 'ISDBA') = 'TRUE' 
    THEN
        RETURN NULL; -- Trả về NULL nghĩa là không có điều kiện lọc WHERE
    END IF;
    RETURN 'UPPER(role) != ''ADMIN''';
END;
/

-- CẤP QUYỀN THỰC THI CHO PUBLIC (ĐỂ POLICY CÓ THỂ CHẠY)
GRANT EXECUTE ON HOSPITAL_ADMIN.fn_vpd_hide_admins TO PUBLIC;

--GẮN POLICY VÀO BẢNG STAFF
BEGIN
    DBMS_RLS.ADD_POLICY (
        object_schema    => 'HOSPITAL_ADMIN',
        object_name      => 'STAFF',
        policy_name      => 'vpd_hide_admin_rows',
        function_schema  => 'HOSPITAL_ADMIN',
        policy_function  => 'fn_vpd_hide_admins',
        statement_types  => 'SELECT',
        update_check     => TRUE,
        static_policy    => FALSE -- False để nó kiểm tra lại Context mỗi khi có truy vấn
    );
END;
/
-- VPD 3: Admin và nurse sẽ có thể select, doctor sẽ chỉ thấy các đơn thuốc do chính mình tạo ra (staff_id).
CREATE OR REPLACE FUNCTION policy_auth_prescription (
    schema_p IN VARCHAR2,
    table_p  IN VARCHAR2
) RETURN VARCHAR2 IS
    v_username VARCHAR2(50);
    v_role     VARCHAR2(20);
    v_staff_id NUMBER;
BEGIN
    v_username := SYS_CONTEXT('USERENV', 'SESSION_USER');

    -- Admin/System thấy hết
    IF v_username = 'HOSPITAL_ADMIN' OR v_username = 'SYS' THEN RETURN '1=1'; END IF;

    IF get_user_staff_info(v_username, v_role, v_staff_id) THEN
        IF v_role = 'DOCTOR' THEN
            -- [NÂNG CẤP]: Kiểm tra thêm điều kiện EXISTS trong bảng VISIT
            -- Nghĩa là: Chỉ được thao tác nếu staff_id là của mình 
            -- VÀ visit_id đó cũng do chính mình khám (staff_id trong bảng VISIT trùng với mình)
            RETURN 'staff_id = ' || v_staff_id || 
                   ' AND EXISTS (SELECT 1 FROM VISIT v 
                                 WHERE v.visit_id = ' || table_p || '.visit_id 
                                 AND v.staff_id = ' || v_staff_id || ')';
                                 
        ELSIF v_role IN ('NURSE', 'ADMIN') THEN
            RETURN '1=1';
        ELSE
            RETURN '1=0';
        END IF;
    ELSE
        RETURN '1=0';
    END IF;
END;
/
-- VPD 4: Admin và nurse sẽ có thể select, doctor sẽ chỉ thấy các prescription_detail do chính mình tạo ra (staff_id).
CREATE OR REPLACE FUNCTION policy_auth_pres_detail (
    schema_p IN VARCHAR2,
    table_p  IN VARCHAR2
) RETURN VARCHAR2 IS
    v_username VARCHAR2(50);
    v_role     VARCHAR2(20);
    v_staff_id NUMBER;
BEGIN
    v_username := SYS_CONTEXT('USERENV', 'SESSION_USER');

    -- 1. Admin hệ thống và Schema chủ được thấy hết
    IF v_username = 'HOSPITAL_ADMIN' OR v_username = 'SYS' THEN 
        RETURN '1=1'; 
    END IF;

    -- 2. Lấy thông tin nhân viên
    IF get_user_staff_info(v_username, v_role, v_staff_id) THEN
        
        -- TRƯỜNG HỢP BÁC SĨ (DOCTOR)
        IF v_role = 'DOCTOR' THEN
            -- Logic: Chỉ thấy dòng chi tiết thuốc NẾU đơn thuốc cha (PRESCRIPTION) có staff_id là của mình
            -- Sử dụng 'EXISTS' để kết nối sang bảng PRESCRIPTION
            RETURN 'EXISTS (
                        SELECT 1 FROM PRESCRIPTION p 
                        WHERE p.prescription_id = ' || table_p || '.prescription_id 
                        AND p.staff_id = ' || v_staff_id || '
                    )';
        
        -- TRƯỜNG HỢP Y TÁ (NURSE) HOẶC ADMIN BỆNH VIỆN
        ELSIF v_role IN ('NURSE', 'ADMIN') THEN
            RETURN '1=1'; -- Thấy hết để lấy thuốc/quản lý
            
        ELSE
            RETURN '1=0'; -- Role lạ chặn hết
        END IF;
    ELSE
        RETURN '1=0'; -- Không phải nhân viên chặn hết
    END IF;
END;
/
--------------------------------------------------------------------
-- OLS
--------------------------------------------------------------------
EXEC sa_components.create_level('HOSPITAL_OLS', 1000, 'PUB',  'NEW_VISIT');
EXEC sa_components.create_level('HOSPITAL_OLS', 2000, 'CONF', 'IN_PROGRESS');
EXEC sa_components.create_level('HOSPITAL_OLS', 3000, 'SEC',  'DIAGNOSED');

EXEC sa_components.create_compartment('HOSPITAL_OLS', 10, 'INT', 'Internal Medicine');
EXEC sa_components.create_compartment('HOSPITAL_OLS', 20, 'SUR', 'Surgery');
EXEC sa_components.create_compartment('HOSPITAL_OLS', 30, 'PED', 'Pediatrics');
EXEC sa_components.create_compartment('HOSPITAL_OLS', 40, 'ER', 'Emergency');
EXEC sa_components.create_compartment('HOSPITAL_OLS', 50, 'ADM', 'Administration');

EXEC sa_components.create_group('HOSPITAL_OLS', 1, 'CLI', 'Clinical');


BEGIN
    sa_user_admin.set_user_labels (
        policy_name => 'HOSPITAL_OLS',
        user_name => 'NURSE_TU',
        max_read_label => 'PUB::CLI',
        max_write_label => 'PUB::CLI',
        def_label => 'PUB::CLI',
        row_label => 'PUB::CLI'
    );
END;
BEGIN
    sa_user_admin.set_user_labels (
        policy_name => 'HOSPITAL_OLS',
        user_name => 'DOCTOR_AN',
        max_read_label => 'SEC:INT:CLI',
        max_write_label => 'SEC:INT:CLI',
        def_label => 'SEC:INT:CLI',
        row_label => 'SEC:INT:CLI'
    );
END;
BEGIN
    sa_user_admin.set_user_labels (
        policy_name => 'HOSPITAL_OLS',
        user_name => 'ADMIN01',
        max_read_label => 'SEC::CLI',
        max_write_label => NULL,
        min_write_label => NULL,
        def_label => 'SEC::CLI',
        row_label => 'SEC::CLI'
    );
END;
BEGIN 
    sa_user_admin.set_user_privs (
        policy_name => 'HOSPITAL_OLS',
        user_name => 'HOSPITAL_ADMIN',
        PRIVILEGES => 'FULL'
    );
END;

-- Tạo hàm gán nhãn
CREATE OR REPLACE FUNCTION hospital_admin.gen_visit_label (
    p_department_id NUMBER,
    p_diagnosis CLOB,
    p_staffid NUMBER
) RETURN LBACSYS.LBAC_LABEL
AS
    v_label VARCHAR2(100);
BEGIN
    IF p_staffid IS NULL THEN
        v_label := 'PUB:';
    ELSIF p_diagnosis IS NULL THEN
        v_label := 'CONF:';
    ELSE
        v_label := 'SEC:';
    END IF;

    CASE p_department_id
        WHEN 1 THEN v_label := v_label || 'INT';
        WHEN 2 THEN v_label := v_label || 'SUR';
        WHEN 3 THEN v_label := v_label || 'PED';
        WHEN 4 THEN v_label := v_label || 'ER';
        ELSE v_label := v_label || 'ADM';
    END CASE;

    v_label := v_label || ':CLI';

    RETURN TO_LBAC_DATA_LABEL('HOSPITAL_OLS', v_label);
END;


GRANT execute ON hospital_admin.gen_visit_label TO lbacsys;
GRANT EXECUTE ON hospital_admin.gen_visit_label TO LBAC_TRIGGER;

-- Áp dụng chính sách với option => HIDE và NO_CONTROL để gán nhãn dữ liệu thủ công cho các dữ liệu đã thêm trước đó
UPDATE visit
SET ols_column = char_to_label('HOSPITAL_OLS', 'SEC:INT:CLI')
WHERE department_id = 1;
-- Khoa Ngoại
UPDATE visit
SET ols_column = char_to_label('HOSPITAL_OLS', 'SEC:SUR:CLI')
WHERE department_id = 2;
-- Khoa Nhi
UPDATE visit
SET ols_column = char_to_label('HOSPITAL_OLS', 'SEC:PED:CLI')
WHERE department_id = 3;
-- Khoa Cấp cứu
UPDATE visit
SET ols_column = char_to_label('HOSPITAL_OLS', 'SEC:ER:CLI')
WHERE department_id = 4;
-- Hành chính (nếu có)
UPDATE visit
SET ols_column = char_to_label('HOSPITAL_OLS', 'SEC:ADM:CLI')
WHERE department_id = 5;
COMMIT;
--  Xóa chính sách đã áp dụng và thêm lại chính sách với các option mới cùng gắn hàm đã tạo ở trước để đánh nhán dữ liệu
BEGIN 
    sa_policy_admin.remove_table_policy (
        policy_name => 'HOSPITAL_OLS',
        schema_name => 'HOSPITAL_ADMIN',
        table_name => 'VISIT'
    ); 
    
    sa_policy_admin.apply_table_policy (
        policy_name => 'HOSPITAL_OLS',
        schema_name => 'HOSPITAL_ADMIN',
        table_name => 'VISIT',
        table_options => 'HIDE,READ_CONTROL,WRITE_CONTROL,CHECK_CONTROL',
        label_function => 'hospital_admin.gen_visit_label(:new.department_id, :new.diagnosis, :new.staff_id)'
    ); 
END;

-- Tạo Stored Procedure (Wrapper Procedure) để tự động tạo oracle db user và tự động gán nhãn user label.
-- 1. Hàm trợ giúp: Map Department ID sang OLS Compartment
CREATE OR REPLACE FUNCTION get_ols_compartment(p_dept_id NUMBER) 
RETURN VARCHAR2 IS
BEGIN
    CASE p_dept_id
        WHEN 1 THEN RETURN 'INT'; -- Nội
        WHEN 2 THEN RETURN 'SUR'; -- Ngoại
        WHEN 3 THEN RETURN 'PED'; -- Nhi
        WHEN 4 THEN RETURN 'ER';  -- Cấp cứu
        WHEN 5 THEN RETURN 'ADM'; -- Hành chính
        ELSE RETURN NULL;
    END CASE;
END;
/

-- 2. Procedure chính: Tạo User, Gán Role, Gán OLS Label, Insert bảng Staff
CREATE OR REPLACE PROCEDURE create_hospital_staff_user (
    p_full_name     IN VARCHAR2,
    p_username      IN VARCHAR2,
    p_password      IN VARCHAR2, -- Mật khẩu thô để tạo DB User
    p_role          IN VARCHAR2, -- 'DOCTOR', 'NURSE', 'ADMIN'
    p_phone         IN VARCHAR2,
    p_email         IN VARCHAR2,
    p_dept_id       IN NUMBER,
    p_salary        IN NUMBER,
    p_hashed_pass   IN VARCHAR2  -- Mật khẩu hash để lưu vào bảng STAFF (cho app login)
) AUTHID CURRENT_USER AS
    v_sql           VARCHAR2(1000);
    v_ols_label     VARCHAR2(200);
    v_compartment   VARCHAR2(10);
    v_db_role       VARCHAR2(50);
BEGIN
    -- A. Insert vào bảng STAFF (để lưu hồ sơ nhân sự)
    INSERT INTO STAFF (full_name, username, password_hash, role, phone, email, department_id, salary)
    VALUES (p_full_name, p_username, p_hashed_pass, p_role, p_phone, p_email, p_dept_id, p_salary);

    -- B. Tạo Oracle User (Dynamic SQL vì DDL không chạy trực tiếp trong PL/SQL)
    v_sql := 'CREATE USER ' || p_username || ' IDENTIFIED BY "' || p_password || '" DEFAULT TABLESPACE USERS QUOTA UNLIMITED ON USERS';
    EXECUTE IMMEDIATE v_sql;

    v_sql := 'GRANT CONNECT, RESOURCE TO ' || p_username;
    EXECUTE IMMEDIATE v_sql;

    -- C. Gán Role tương ứng
    IF p_role = 'ADMIN' THEN
        v_db_role := 'admin_role';
    ELSIF p_role = 'DOCTOR' THEN
        v_db_role := 'doctor_role';
    ELSIF p_role = 'NURSE' THEN
        v_db_role := 'nurse_role';
    END IF;
    
    IF v_db_role IS NOT NULL THEN
        v_sql := 'GRANT ' || v_db_role || ' TO ' || p_username;
        EXECUTE IMMEDIATE v_sql;
    END IF;

    -- D. Gán nhãn OLS (Logic phức tạp nhất)
    -- Lấy mã khoa (Compartment)
    v_compartment := get_ols_compartment(p_dept_id);
    
    IF v_compartment IS NOT NULL THEN
        -- Logic tạo label string dựa trên Role
        IF p_role = 'NURSE' THEN
            v_ols_label := 'PUB:INT,SUR,PED,ER,ADM:CLI';
            
        ELSIF p_role = 'DOCTOR' THEN
            v_ols_label := 'SEC:' || v_compartment || ':CLI';
            
        ELSIF p_role = 'ADMIN' THEN
            v_ols_label := 'SEC:INT,SUR,PED,ER,ADM:CLI';
        END IF;

        -- Gọi hàm OLS policy (Cần quyền LBAC_DBA hoặc quyền execute trên package này)
        sa_user_admin.set_user_labels (
            policy_name     => 'HOSPITAL_OLS',
            user_name       => UPPER(p_username),
            max_read_label  => v_ols_label,
            max_write_label => v_ols_label,
            def_label       => v_ols_label,
            row_label       => v_ols_label
        );
    END IF;

    COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END;
/
