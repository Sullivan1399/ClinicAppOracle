/* ==================================================
   PHẦN 1: DDL - TẠO BẢNG VÀ RÀNG BUỘC
   Cập nhật: Bỏ cột 'status' trong bảng VISIT
   ================================================== */

-- Xóa các bảng cũ để làm sạch môi trường
DROP TABLE PRESCRIPTION_DETAIL CASCADE CONSTRAINTS;
DROP TABLE PRESCRIPTION CASCADE CONSTRAINTS;
DROP TABLE VISIT CASCADE CONSTRAINTS;
DROP TABLE STAFF CASCADE CONSTRAINTS;
DROP TABLE PATIENT CASCADE CONSTRAINTS;
DROP TABLE MEDICINE CASCADE CONSTRAINTS;
DROP TABLE DEPARTMENT CASCADE CONSTRAINTS;

-- 1. Bảng DEPARTMENT
CREATE TABLE DEPARTMENT (
    department_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    department_name VARCHAR2(100) NOT NULL
);

-- 2. Bảng MEDICINE
CREATE TABLE MEDICINE (
    medicine_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    medicine_name VARCHAR2(150) NOT NULL,
    unit VARCHAR2(50),
    price NUMBER
);

-- 3. Bảng PATIENT
CREATE TABLE PATIENT (
    patient_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    full_name VARCHAR2(100) NOT NULL,
    dob DATE,
    gender CHAR(1) CHECK (gender IN ('M', 'F')),
    phone VARCHAR2(20),
    address VARCHAR2(255),
    insurance_number VARCHAR2(50)
);

-- 4. Bảng STAFF
CREATE TABLE STAFF (
    staff_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    full_name VARCHAR2(100) NOT NULL,
    username VARCHAR2(50) UNIQUE NOT NULL,
    password_hash VARCHAR2(200) NOT NULL,
    role VARCHAR2(20) CHECK (role IN ('DOCTOR', 'NURSE', 'ADMIN')),
    phone VARCHAR2(20),
    email VARCHAR2(100),
    department_id NUMBER,
    salary NUMBER,
    CONSTRAINT fk_staff_dept FOREIGN KEY (department_id) REFERENCES DEPARTMENT(department_id)
);

-- 5. Bảng VISIT
-- Đã xóa cột 'status'
CREATE TABLE VISIT (
    visit_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    patient_id NUMBER NOT NULL,
    staff_id NUMBER NOT NULL, -- Bác sĩ khám
    department_id NUMBER,     -- Khoa khám
    visit_date DATE DEFAULT SYSDATE,
    diagnosis CLOB,
    notes CLOB,
    CONSTRAINT fk_visit_patient FOREIGN KEY (patient_id) REFERENCES PATIENT(patient_id),
    CONSTRAINT fk_visit_staff FOREIGN KEY (staff_id) REFERENCES STAFF(staff_id),
    CONSTRAINT fk_visit_dept FOREIGN KEY (department_id) REFERENCES DEPARTMENT(department_id)
);

-- 6. Bảng PRESCRIPTION
CREATE TABLE PRESCRIPTION (
    prescription_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    visit_id NUMBER NOT NULL,
    staff_id NUMBER NOT NULL,
    created_date DATE DEFAULT SYSDATE,
    notes VARCHAR2(255),
    CONSTRAINT fk_pres_visit FOREIGN KEY (visit_id) REFERENCES VISIT(visit_id),
    CONSTRAINT fk_pres_staff FOREIGN KEY (staff_id) REFERENCES STAFF(staff_id)
);

-- 7. Bảng PRESCRIPTION_DETAIL
CREATE TABLE PRESCRIPTION_DETAIL (
    detail_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    prescription_id NUMBER NOT NULL,
    medicine_id NUMBER NOT NULL,
    quantity NUMBER NOT NULL,
    dosage VARCHAR2(100),
    CONSTRAINT fk_detail_pres FOREIGN KEY (prescription_id) REFERENCES PRESCRIPTION(prescription_id),
    CONSTRAINT fk_detail_med FOREIGN KEY (medicine_id) REFERENCES MEDICINE(medicine_id)
);


/* ==================================================
   PHẦN 2: DML - INSERT DỮ LIỆU MẪU
   Đã cập nhật câu lệnh INSERT cho bảng VISIT (bỏ giá trị status)
   ================================================== */

-- 1. Data for DEPARTMENT
INSERT INTO DEPARTMENT (department_name) VALUES ('Khoa Nội tổng hợp');
INSERT INTO DEPARTMENT (department_name) VALUES ('Khoa Ngoại');
INSERT INTO DEPARTMENT (department_name) VALUES ('Khoa Nhi');
INSERT INTO DEPARTMENT (department_name) VALUES ('Khoa Cấp cứu');
INSERT INTO DEPARTMENT (department_name) VALUES ('Phòng Hành chính');

-- 2. Data for MEDICINE
INSERT INTO MEDICINE (medicine_name, unit, price) VALUES ('Paracetamol 500mg', 'Viên', 1000);
INSERT INTO MEDICINE (medicine_name, unit, price) VALUES ('Ibuprofen 400mg', 'Viên', 2500);
INSERT INTO MEDICINE (medicine_name, unit, price) VALUES ('Amoxicillin 500mg', 'Viên', 3000);
INSERT INTO MEDICINE (medicine_name, unit, price) VALUES ('Omeprazol 20mg', 'Viên', 4000);
INSERT INTO MEDICINE (medicine_name, unit, price) VALUES ('Vitamin C sủi', 'Tuýp', 20000);
INSERT INTO MEDICINE (medicine_name, unit, price) VALUES ('Dung dịch Oresol', 'Gói', 2000);
INSERT INTO MEDICINE (medicine_name, unit, price) VALUES ('Thuốc ho long đờm', 'Chai', 35000);
INSERT INTO MEDICINE (medicine_name, unit, price) VALUES ('Betadine sát khuẩn', 'Lọ', 45000);
INSERT INTO MEDICINE (medicine_name, unit, price) VALUES ('Panadol Extra', 'Vỉ', 12000);
INSERT INTO MEDICINE (medicine_name, unit, price) VALUES ('Men vi sinh', 'Ống', 8000);

-- 3. Data for PATIENT
INSERT INTO PATIENT (full_name, dob, gender, phone, address, insurance_number) VALUES ('Nguyễn Văn An', TO_DATE('1990-05-15', 'YYYY-MM-DD'), 'M', '0901234567', '123 Nguyễn Trãi, Hà Nội', 'BH123456789');
INSERT INTO PATIENT (full_name, dob, gender, phone, address, insurance_number) VALUES ('Trần Thị Bình', TO_DATE('1985-10-20', 'YYYY-MM-DD'), 'F', '0909876543', '456 Lê Lợi, TP.HCM', 'BH987654321');
INSERT INTO PATIENT (full_name, dob, gender, phone, address, insurance_number) VALUES ('Lê Văn Cường', TO_DATE('2000-01-01', 'YYYY-MM-DD'), 'M', '0912345678', '789 Trần Hưng Đạo, Đà Nẵng', NULL);
INSERT INTO PATIENT (full_name, dob, gender, phone, address, insurance_number) VALUES ('Phạm Thị Dung', TO_DATE('1978-03-08', 'YYYY-MM-DD'), 'F', '0987654321', 'Số 10 Ngõ 5, Cầu Giấy, HN', 'BH567890123');
INSERT INTO PATIENT (full_name, dob, gender, phone, address, insurance_number) VALUES ('Hoàng Tuấn Anh', TO_DATE('1995-12-25', 'YYYY-MM-DD'), 'M', '0933334444', 'Quận 7, TP.HCM', NULL);
INSERT INTO PATIENT (full_name, dob, gender, phone, address, insurance_number) VALUES ('Ngô Lan Chi', TO_DATE('2015-06-01', 'YYYY-MM-DD'), 'F', '0911223344', 'Ba Đình, Hà Nội', 'BH_CHILD_001');
INSERT INTO PATIENT (full_name, dob, gender, phone, address, insurance_number) VALUES ('Vũ Minh Đức', TO_DATE('1960-09-12', 'YYYY-MM-DD'), 'M', '0955667788', 'Hải Châu, Đà Nẵng', 'BH_RETIRED_99');
INSERT INTO PATIENT (full_name, dob, gender, phone, address, insurance_number) VALUES ('Đặng Thu Hà', TO_DATE('1992-04-30', 'YYYY-MM-DD'), 'F', '0999888777', 'Nha Trang, Khánh Hòa', 'BH_CORP_ABC');
INSERT INTO PATIENT (full_name, dob, gender, phone, address, insurance_number) VALUES ('Bùi Văn Khoa', TO_DATE('1988-07-19', 'YYYY-MM-DD'), 'M', '0944555666', 'Biên Hòa, Đồng Nai', NULL);
INSERT INTO PATIENT (full_name, dob, gender, phone, address, insurance_number) VALUES ('Đỗ Thị Linh', TO_DATE('2005-11-20', 'YYYY-MM-DD'), 'F', '0977778888', 'Thủ Đức, TP.HCM', 'BH_STUDENT_55');

-- 4. Data for STAFF
INSERT INTO STAFF (full_name, username, password_hash, role, phone, email, department_id, salary) VALUES ('Nguyễn Quản Trị', 'admin01', 'hashed_pass_1', 'ADMIN', '0909000111', 'admin01@hospital.com', 5, 25000000);
INSERT INTO STAFF (full_name, username, password_hash, role, phone, email, department_id, salary) VALUES ('Lê Hỗ Trợ', 'admin02', 'hashed_pass_2', 'ADMIN', '0909000222', 'support@hospital.com', 5, 18000000);
INSERT INTO STAFF (full_name, username, password_hash, role, phone, email, department_id, salary) VALUES ('Bs. Trần Bình An', 'doctor_an', 'pass_doc1', 'DOCTOR', '0911111222', 'an.tran@hospital.com', 1, 35000000);
INSERT INTO STAFF (full_name, username, password_hash, role, phone, email, department_id, salary) VALUES ('Bs. Phạm Minh Tâm', 'doctor_tam', 'pass_doc2', 'DOCTOR', '0911111333', 'tam.pham@hospital.com', 1, 32000000);
INSERT INTO STAFF (full_name, username, password_hash, role, phone, email, department_id, salary) VALUES ('Bs. Lê Cường Quốc', 'doctor_quoc', 'pass_doc3', 'DOCTOR', '0922222333', 'quoc.le@hospital.com', 2, 40000000);
INSERT INTO STAFF (full_name, username, password_hash, role, phone, email, department_id, salary) VALUES ('Bs. Hoàng Yến Nhi', 'doctor_nhi', 'pass_doc4', 'DOCTOR', '0933333555', 'nhi.hoang@hospital.com', 3, 30000000);
INSERT INTO STAFF (full_name, username, password_hash, role, phone, email, department_id, salary) VALUES ('Bs. Vũ Việt Hùng', 'doctor_hung', 'pass_doc5', 'DOCTOR', '0933333666', 'hung.vu@hospital.com', 4, 38000000);
INSERT INTO STAFF (full_name, username, password_hash, role, phone, email, department_id, salary) VALUES ('Bs. Đặng Phương Thảo', 'doctor_thao', 'pass_doc6', 'DOCTOR', '0944444777', 'thao.dang@hospital.com', 4, 36000000);
INSERT INTO STAFF (full_name, username, password_hash, role, phone, email, department_id, salary) VALUES ('Yt. Nguyễn Mai Phương', 'nurse_phuong', 'pass_nurse1', 'NURSE', '0955555111', NULL, 1, 15000000);
INSERT INTO STAFF (full_name, username, password_hash, role, phone, email, department_id, salary) VALUES ('Yt. Trần Thị Thu', 'nurse_thu', 'pass_nurse2', 'NURSE', '0955555222', NULL, 2, 14500000);
INSERT INTO STAFF (full_name, username, password_hash, role, phone, email, department_id, salary) VALUES ('Yt. Lê Thanh Tú', 'nurse_tu', 'pass_nurse3', 'NURSE', '0955555333', NULL, 3, 14000000);
INSERT INTO STAFF (full_name, username, password_hash, role, phone, email, department_id, salary) VALUES ('Yt. Phạm Thị Hoa', 'nurse_hoa', 'pass_nurse4', 'NURSE', '0955555444', NULL, 4, 16000000);

-- 5. Data for VISIT (ĐÃ XÓA STATUS)
INSERT INTO VISIT (patient_id, staff_id, department_id, visit_date, diagnosis, notes) VALUES (1, 3, 1, TO_DATE('2023-10-01 08:30', 'YYYY-MM-DD HH24:MI'), 'Viêm họng cấp', 'Sốt nhẹ, đau rát họng.');
INSERT INTO VISIT (patient_id, staff_id, department_id, visit_date, diagnosis, notes) VALUES (2, 4, 1, TO_DATE('2023-10-02 09:15', 'YYYY-MM-DD HH24:MI'), 'Rối loạn tiêu hóa', 'Tiêu chảy cấp.');
INSERT INTO VISIT (patient_id, staff_id, department_id, visit_date, diagnosis, notes) VALUES (3, 5, 2, TO_DATE('2023-10-03 14:00', 'YYYY-MM-DD HH24:MI'), 'Chấn thương phần mềm vai phải', 'Do ngã xe.');
INSERT INTO VISIT (patient_id, staff_id, department_id, visit_date, diagnosis, notes) VALUES (6, 6, 3, TO_DATE('2023-10-05 10:00', 'YYYY-MM-DD HH24:MI'), 'Sốt virus', 'Bé sốt cao 39 độ.');
INSERT INTO VISIT (patient_id, staff_id, department_id, visit_date, diagnosis, notes) VALUES (4, 3, 1, TO_DATE('2023-10-10 11:30', 'YYYY-MM-DD HH24:MI'), 'Tăng huyết áp', 'Tái khám định kỳ.');
INSERT INTO VISIT (patient_id, staff_id, department_id, visit_date, diagnosis, notes) VALUES (5, 5, 2, TO_DATE('2023-10-12 16:45', 'YYYY-MM-DD HH24:MI'), 'Đau dạ dày cấp', 'Tiền sử viêm loét dạ dày.');
INSERT INTO VISIT (patient_id, staff_id, department_id, visit_date, diagnosis, notes) VALUES (7, 7, 4, TO_DATE('2023-10-15 19:30', 'YYYY-MM-DD HH24:MI'), 'Dị ứng cấp', 'Nổi mề đay toàn thân.');
INSERT INTO VISIT (patient_id, staff_id, department_id, visit_date, diagnosis, notes) VALUES (8, 4, 1, TO_DATE('2023-10-18 08:00', 'YYYY-MM-DD HH24:MI'), 'Kiểm tra sức khỏe', 'Không có triệu chứng bất thường.');
INSERT INTO VISIT (patient_id, staff_id, department_id, visit_date, diagnosis, notes) VALUES (9, 7, 4, TO_DATE('2023-10-20 13:15', 'YYYY-MM-DD HH24:MI'), 'Bong gân cổ chân', 'Đã sơ cứu.');
INSERT INTO VISIT (patient_id, staff_id, department_id, visit_date, diagnosis, notes) VALUES (10, 6, 3, TO_DATE('2023-10-22 09:45', 'YYYY-MM-DD HH24:MI'), 'Viêm phế quản', 'Ho nhiều, có đờm.');
INSERT INTO VISIT (patient_id, staff_id, department_id, visit_date, diagnosis, notes) VALUES (1, 3, 1, TO_DATE('2023-10-25 15:30', 'YYYY-MM-DD HH24:MI'), 'Tái khám viêm họng', 'Đã đỡ nhiều, tiếp tục thuốc.');
INSERT INTO VISIT (patient_id, staff_id, department_id, visit_date, diagnosis, notes) VALUES (2, 4, 1, SYSDATE - 1, 'Theo dõi tiêu hóa', NULL);
INSERT INTO VISIT (patient_id, staff_id, department_id, visit_date, diagnosis, notes) VALUES (3, 5, 2, SYSDATE - 1, 'Tái khám chấn thương', 'Cần chụp X-quang lại.');
INSERT INTO VISIT (patient_id, staff_id, department_id, visit_date, diagnosis, notes) VALUES (4, 3, 1, SYSDATE, 'Cảm cúm thông thường', NULL);
INSERT INTO VISIT (patient_id, staff_id, department_id, visit_date, diagnosis, notes) VALUES (5, 7, 4, SYSDATE, 'Tai nạn giao thông', 'Vết thương phần mềm tay trái.');

-- 6. Data for PRESCRIPTION
INSERT INTO PRESCRIPTION (visit_id, staff_id, created_date, notes) VALUES (1, 3, TO_DATE('2023-10-01 08:45', 'YYYY-MM-DD HH24:MI'), 'Uống đủ 5 ngày.');
INSERT INTO PRESCRIPTION (visit_id, staff_id, created_date, notes) VALUES (2, 4, TO_DATE('2023-10-02 09:30', 'YYYY-MM-DD HH24:MI'), 'Bù nước điện giải.');
INSERT INTO PRESCRIPTION (visit_id, staff_id, created_date, notes) VALUES (3, 5, TO_DATE('2023-10-03 14:20', 'YYYY-MM-DD HH24:MI'), 'Nghỉ ngơi 1 tuần.');
INSERT INTO PRESCRIPTION (visit_id, staff_id, created_date, notes) VALUES (4, 6, TO_DATE('2023-10-05 10:20', 'YYYY-MM-DD HH24:MI'), 'Uống thuốc hạ sốt khi cần.');
INSERT INTO PRESCRIPTION (visit_id, staff_id, created_date, notes) VALUES (5, 3, TO_DATE('2023-10-10 11:50', 'YYYY-MM-DD HH24:MI'), 'Duy trì thuốc huyết áp.');
INSERT INTO PRESCRIPTION (visit_id, staff_id, created_date, notes) VALUES (6, 5, TO_DATE('2023-10-12 17:00', 'YYYY-MM-DD HH24:MI'), 'Kiêng đồ cay nóng.');
INSERT INTO PRESCRIPTION (visit_id, staff_id, created_date, notes) VALUES (7, 7, TO_DATE('2023-10-15 19:50', 'YYYY-MM-DD HH24:MI'), 'Theo dõi phản ứng thuốc.');
INSERT INTO PRESCRIPTION (visit_id, staff_id, created_date, notes) VALUES (8, 4, TO_DATE('2023-10-18 08:30', 'YYYY-MM-DD HH24:MI'), 'Bổ sung Vitamin.');
INSERT INTO PRESCRIPTION (visit_id, staff_id, created_date, notes) VALUES (9, 7, TO_DATE('2023-10-20 13:30', 'YYYY-MM-DD HH24:MI'), 'Chườm lạnh.');
INSERT INTO PRESCRIPTION (visit_id, staff_id, created_date, notes) VALUES (10, 6, TO_DATE('2023-10-22 10:00', 'YYYY-MM-DD HH24:MI'), 'Kháng sinh 7 ngày.');
INSERT INTO PRESCRIPTION (visit_id, staff_id, created_date, notes) VALUES (11, 3, TO_DATE('2023-10-25 15:45', 'YYYY-MM-DD HH24:MI'), 'Tái khám sau 2 ngày.');
INSERT INTO PRESCRIPTION (visit_id, staff_id, created_date, notes) VALUES (12, 4, SYSDATE - 1, 'Uống Men vi sinh.');
INSERT INTO PRESCRIPTION (visit_id, staff_id, created_date, notes) VALUES (13, 5, SYSDATE - 1, 'Thuốc giảm đau mạnh.');
INSERT INTO PRESCRIPTION (visit_id, staff_id, created_date, notes) VALUES (14, 3, SYSDATE, 'Nghỉ ngơi, giữ ấm.');
INSERT INTO PRESCRIPTION (visit_id, staff_id, created_date, notes) VALUES (15, 7, SYSDATE, 'Kháng sinh dự phòng nhiễm trùng.');

-- 7. Data for PRESCRIPTION_DETAIL
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (1, 1, 10, 'Ngày 2 viên, chia 2 lần');
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (1, 3, 15, 'Ngày 3 viên, chia 3 lần');
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (2, 6, 5, 'Pha 1 gói với 200ml nước');
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (2, 10, 20, 'Ngày 2 ống');
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (3, 2, 10, 'Ngày 2 viên khi đau');
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (4, 1, 5, 'Uống 1/2 viên khi sốt > 38.5');
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (4, 5, 1, 'Ngày 1 viên sủi');
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (5, 9, 30, 'Ngày 1 viên (thay thế thuốc huyết áp)');
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (6, 4, 20, 'Ngày 2 viên, trước ăn');
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (7, 9, 10, 'Ngày 2 viên (thay thế thuốc dị ứng)');
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (8, 5, 1, 'Mỗi ngày 1 viên sủi');
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (9, 2, 10, 'Uống khi đau');
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (9, 8, 1, 'Băng gạc sau khi sát khuẩn');
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (10, 3, 20, 'Ngày 2 viên, uống đủ 10 ngày');
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (10, 7, 1, 'Ngày uống 3 lần, mỗi lần 15ml');
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (11, 7, 1, 'Ngậm khi ho');
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (12, 10, 10, 'Ngày 1 ống trước khi ăn');
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (13, 2, 15, 'Ngày 3 viên');
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (14, 1, 10, 'Ngày 2 lần để giảm đau, hạ sốt');
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (14, 5, 1, 'Mỗi ngày 1 viên');
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (15, 3, 10, 'Ngày 2 viên');
INSERT INTO PRESCRIPTION_DETAIL (prescription_id, medicine_id, quantity, dosage) VALUES (15, 8, 1, 'Sát trùng vết thương');

COMMIT;